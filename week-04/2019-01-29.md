Tuesday, January 29, 2019
=====================
### Video Resources (Echo Platoon)
- [Week 4 Videos](https://www.youtube.com/watch?v=ra2IXfFlZK8&list=PLu0CiQ7bzwERLJOhwkQA9vQKpsw_McWCb)
- Work on these [SQL](https://pgexercises.com/)
# Connecting Django to Postgresql 

## Creating a Virtual Environment

Before we work with django we need to create a virtual environment and then start it up. 
##### Create env 
`python -m venv <envname>`

##### Start env
`source <envname>/bin/activate`

##### Eject from env
`deactivate`

## Starting a New Django Project
Once we have our virtual venv up and running, we can install django and start a new project. 
```bash

$ pip install django
$ django-admin startproject <projectname>
$ cd <projectname>

```
## Create a database 
```bash 
$ createdb school
```
## Pyscopg2
Now we can install the python library that will help django talk to postgres. 

```bash
$ pip install psycopg2
```
And then tell Django we want to use postgres as our database. Django uses Sqllite by default. That is not what we want. 

```python
# school/settings.py 

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'school',
    }
}
```

## Create our App
Django projects are split into many apps. We will work with one for now. 
```bash
$ python manage.py startapp students
```
Then we need to add that app to our project. 
```python
# school/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'students'
]
```

## Create Our Model 
Now we can create our model. 

```python
# students/models.py
from django.db import models

class Post(models.Model):
  name   = models.CharField(max_length=200)
  email  = models.CharField(max_length=200)

```

Now we tell Django to create some python code that can tell our sql database to create a students table with the correct columns. 
```bash
$ python manage.py makemigrations students
```
This command just creates the code for us, it doesn't run it. We need another command to do that. 
```bash
$ python manage.py migrate
```
Now we should have a students table in our db. 

## Python Console 
We can interact with our db using postgres, more often we want to interact with our data using python code. We can do that by setting up a console for our project that will pull in all our python classes and allow us to query the db directly using python and Django's ORM. This takes a little bit of set up. First we need to install `django-extensions` which adds some functionality to our project. We can also grab `ipython` while we are at it. 

```bash
$ pip install django-extensions
$ pip install ipython
```
Then we need to tell our Django project to start using the django extensions library. 
```python
# school/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'students', 
    'django_extensions
]

```

Now we can start our shell with `python manage.py shell_plus --ipython`. The shell will load in all of our models and libraries form Django. Once in the shell, we can create a new student. 

```bash 
In [1]: student = Student(name="Jon", email="jon@jon.com")
In [2]: student.save()
```
Now we can query our db using python and see our new record. 
```bash 
In [3]: Students.objects.all()
```
You should get back a query object. Exit the shell by typing `exit`. Let's confirm that our new record got saved in our postgres db. 

```bash 
psql school 
psql (11.1, server 9.6.3)
Type "help" for help.

school= \d
                          List of relations
 Schema |               Name                |   Type   |     Owner
--------+-----------------------------------+----------+---------------
 public | attendance_student                | table    | joshuaalletto
 public | attendance_student_id_seq         | sequence | joshuaalletto
 public | auth_group                        | table    | joshuaalletto
 ...

```
Django creates our dbs with the project name first, followed by the app name. So `attendance_student` is what we are looking for. Let's query for the records in that table and see what we get. 

```bash 
school=# select * from attendance_student;
 id | name | email
----+------+-----+
  1 | Jon | jon@jon.com
(1 row)

```
